# GPXファイル解析スクリプト（年間ウォーキング集計）

このスクリプトは、指定した年のGPXファイルを解析し、年間の運動記録を集計して出力します。  
従来の「運動日数・距離・時間」に加えて、以下のサマリも出力します。

- (1) **1回あたり平均**（距離 / 時間 / 平均ペース）
- (2) **最長記録**（最長距離 / 最長時間：日付付き）
- (3) **月別サマリ**（回数 / 距離 / 時間 / 平均ペース）
- (4) **曜日別サマリ**（回数 / 距離 / 時間）＋ **週あたり平均回数**

---

## 出力される指標

### 年間サマリ（基本）
- **運動日数**: 指定年に運動を行った回数（※ファイル数）
- **年間累計移動距離**: 運動による総移動距離（km）
- **年間累計運動時間**: 運動に費やした総時間（hours / HH:MM:SS）

### 追加サマリ（改修で追加）
#### (1) 1回あたり平均
- **平均距離**（km/回）
- **平均時間**（hours/回 / HH:MM:SS）
- **平均ペース**（min/km）

#### (2) 最長記録
- **最長距離**（km）とその **日付**
- **最長時間**（hours / HH:MM:SS）とその **日付**

#### (3) 月別サマリ（12行）
- **月ごとの回数 / 距離(km) / 時間(h) / 平均ペース**

#### (4) 曜日別サマリ
- **曜日ごとの回数 / 距離(km) / 時間(h)**
- **週あたり平均回数**（ISO週換算）

---

## 必要要件

- **Ruby 3.x**
- **nokogiri** ライブラリ

Nokogiriがインストールされていない場合：

```bash
gem install nokogiri
````

---

## 使用方法

### 1. GPXファイルの準備

`workout-routes` ディレクトリ内に、以下の形式でGPXファイルを配置してください。

* `route_YYYY-MM-DD_HH.mm(am|pm).gpx`

例：

* `route_2024-01-02_7.46am.gpx`
* `route_2024-12-31_9.31am.gpx`

> **注意**: このスクリプトでは「運動日数」は **該当年のファイル数**としてカウントします。
> 1日に複数GPXファイルがある場合、運動日数（回数）もその分増えます。

### 2. スクリプトの実行

```bash
ruby health_data_summary.rb --year 2025
```

短縮オプション：

```bash
ruby health_data_summary.rb -y 2025
```

---

## 出力例

```
Results for the year 2025:
運動日数: 210
年間累計移動距離: 969.12 km
年間累計運動時間: 145.67 hours (145:40:12)

(1) 1回あたり平均:
  平均距離: 4.62 km / 回
  平均時間: 0.69 hours / 回 (00:41:37)
  平均ペース: 9:01 /km

(2) 最長記録:
  最長距離: 12.34 km (2025-10-12)
  最長時間: 2.10 hours (02:06:00) (2025-03-09)

(3) 月別サマリ:
  月      回数   距離(km)   時間(h)   平均ペース
  2025-01   18      80.12    12.30   9:12 /km
  2025-02   15      72.55    10.88   8:59 /km
  ...

(4) 曜日別サマリ:
  曜日   回数   距離(km)   時間(h)
  日       30     150.20     22.10
  月       28     120.55     18.22
  ...

  週あたり平均回数: 4.04 回/週 (ISO週: 52週換算)
```

---

## ファイル構造の例

```
.
├── health_data_summary.rb
└── workout-routes/
    ├── route_2025-01-02_7.46am.gpx
    ├── route_2025-12-31_9.31am.gpx
    └── ...
```

---

## スクリプトの仕組み（概要）

1. `workout-routes` ディレクトリ内の `route_*.gpx` を走査し、ファイル名から日付を抽出します。
2. 指定年（`--year`）に一致するファイルのみ解析対象にします。
3. 各GPXファイル内のトラックポイント（`<trkpt>`）を順に読み取り、以下を計算します：

   * 連続する2点間の距離（ハバースインの公式）
   * 連続する2点間の経過時間（`<time>` を利用）
4. ファイル単位（= 1回の運動）で **距離・時間** を集計し、それらを年・月・曜日に集約して出力します。

---

## 注意事項

* GPXファイルには `<trkpt>` と `<time>` が含まれている必要があります。
* `<time>` の欠落や時刻の逆行がある場合、該当区間の時間加算をスキップすることがあります（異常値対策）。
* 本スクリプトの「運動時間」は **トラックポイント間の時刻差分の合計**です。
  休憩（停止）時間も含まれる場合があります（ムービング時間の推定は本改修範囲外）。

---

## トラブルシューティング

* **該当年の運動が0件になる**

  * `workout-routes` のディレクトリ名が正しいか
  * ファイル名が `route_YYYY-MM-DD_HH.mm(am|pm).gpx` 形式になっているか
  * `--year` が正しいか

* **距離が0になる / 小さすぎる**

  * GPXに `<trkpt>` が入っているか
  * 緯度経度が正しく入っているか

---

## ライセンス

このスクリプトは自由に利用・改変可能です。
ただし、使用に際して発生した問題については責任を負いません。


